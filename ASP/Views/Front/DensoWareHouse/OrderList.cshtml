@* ~/Views/Front/Order/OrderList.cshtml *@
@using System
@using System.Linq
@using ASP.DTO.DensoDTO
@model IEnumerable<ASP.Models.Front.Order>
@{
    ViewData["Title"] = "Order List";
    Layout = "../Shared/Layout/Front/_Layout";
}
<div class="container-fluid px-4">
    <!-- Header Section -->
    <div class="text-center mb-5 pt-3">
        <h1 class="fw-bold text-primary mb-2 display-4 animate-slide-in-down">
            <i class="bi bi-receipt-cutoff me-2 animate-bounce-slow"></i>Order Management
        </h1>
    </div>
    @if (!Model.Any())
    {
        <div class="text-center py-5 animate-fade-in">
            <i class="bi bi-inbox display-1 text-muted mb-3 animate-rotate-slow"></i>
            <h4 class="text-muted">No orders found.</h4>
            <p class="text-muted">There are no orders available at the moment.</p>
        </div>
    }
    else
    {
        <!-- All Orders Table -->
        <div class="card shadow-lg border-0 mb-4 overflow-hidden animate-slide-in-up" style="border-radius: 20px;">
            <div class="card-header bg-gradient-primary text-white p-4 border-0" style="background: linear-gradient(135deg, #0d6efd 0%, #6610f2 100%);">
                <div class="d-flex justify-content-between align-items-center w-100">
                    <span class="badge bg-light text-primary fs-5 px-3 py-2 rounded-pill animate-scale-in">
                        <i class="bi bi-receipt me-1 animate-bounce-slow"></i>@Model.Count() Orders
                    </span>
                    <div class="d-flex align-items-center gap-3">

                        @if (ViewBag.TotalPages > 1)
                        {
                            <nav aria-label="Order pagination" class="mb-0">
                                <ul class="pagination pagination-sm mb-0">
                                    @if (ViewBag.Page > 1)
                                    {
                                        <li class="page-item">
                                            <a class="page-link" href="?page=@(ViewBag.Page - 1)&pageSize=@ViewBag.PageSize">Previous</a>
                                        </li>
                                    }
                                    @for (int i = Math.Max(1, ViewBag.Page - 2); i <= Math.Min(ViewBag.TotalPages, ViewBag.Page + 2); i++)
                                    {
                                        <li class="page-item @(i == ViewBag.Page ? "active" : "")">
                                            <a class="page-link" href="?page=@i&pageSize=@ViewBag.PageSize">@i</a>
                                        </li>
                                    }
                                    @if (ViewBag.Page < ViewBag.TotalPages)
                                    {
                                        <li class="page-item">
                                            <a class="page-link" href="?page=@(ViewBag.Page + 1)&pageSize=@ViewBag.PageSize">Next</a>
                                        </li>
                                    }
                                </ul>
                            </nav>
                        }
                    </div>
                </div>
            </div>
            <!-- Orders Table -->
            <div class="table-wrapper">
                <table class="table table-hover mb-0 align-middle user-friendly-table" id="ordersTable">
                    <thead class="table-light">
                        <tr>
                            <th class="border-0 fw-semibold text-dark ps-3 py-4"><i class="bi bi-chevron-down me-1"></i>Expand</th>
                            <th class="border-0 fw-semibold text-dark ps-3 py-4"><i class="bi bi-person-badge me-1"></i>Customer Code</th>
                            <th class="border-0 fw-semibold text-dark ps-3 py-4">
                                <span class="truck-box me-1" aria-hidden="true">
                                    <i class="bi bi-truck truck-led" aria-hidden="true"></i>
                                </span>
                                Ship Date
                            </th>
                            <th class="border-0 fw-semibold text-dark ps-3 py-4"><i class="bi bi-arrow-right-circle me-1"></i>Trans Code</th>
                            <th class="border-0 fw-semibold text-dark ps-3 py-4"><i class="bi bi-boxes me-1"></i>Total Pallet</th>
                            <th class="border-0 fw-semibold text-dark ps-3 py-4"><i class="bi bi-grid-3x3-gap me-1"></i>Total Column</th>
                            <th class="border-0 fw-semibold text-dark ps-3 py-4"><i class="bi bi-circle-fill me-1"></i>Status</th>
                            <th class="border-0 fw-semibold text-dark ps-3 py-4"><i class="bi bi-clock me-1"></i>Plan Delivery</th>
                            <th class="border-0 fw-semibold text-dark ps-3 py-4"><i class="bi bi-clock-history me-1"></i>Actions</th>
                        </tr>
                    </thead>
                    <tbody class="table-group-divider">
                        @foreach (var order in Model)
                        {
                            <tr class="align-middle animate-slide-in-up order-row" data-order-id="@order.UId">
                                <td class="ps-3 py-4 text-center">
                                    <button class="btn btn-sm btn-outline-secondary expand-btn rounded-circle" data-bs-toggle="collapse" data-bs-target="#details_@order.UId" aria-expanded="false" title="Expand Order Details">
                                        <i class="bi bi-caret-down"></i>
                                    </button>
                                </td>
                                <td class="fw-medium text-primary ps-3 py-4">@order.CustomerCode</td>
                                <td class="text-primary ps-3 py-4">@order.ShipDate.ToString("MMM dd, yyyy")</td>
                                <td class="text-muted ps-3 py-4">@order.TransCd</td>
                                <td class="fw-semibold text-success ps-3 py-4">@order.TotalPallet <i class="bi bi-check-circle-fill text-success"></i></td>
                                <td class="fw-semibold text-info ps-3 py-4">@order.TotalColumn <i class="bi bi-info-circle text-info"></i></td>
                                <td class="ps-3 py-4">
                                    @{
                                        var status = order.OrderStatus switch
                                        {
                                            0 => "Planned",
                                            1 => "Pending",
                                            2 => "Completed",
                                            3 => "Shipped",
                                            4 => "Delay",
                                            _ => "Unknown"
                                        };
                                        var badgeClass = order.OrderStatus switch
                                        {
                                            0 => "bg-dark text-white",
                                            1 => "bg-primary text-white",
                                            2 => "bg-success text-white",
                                            3 => "bg-warning text-dark",
                                            4 => "bg-danger text-white",
                                            _ => "bg-secondary text-white"
                                        };
                                        var iconClass = order.OrderStatus switch { 0 => "clock", 1 => "hourglass-split", 2 => "check-circle", 3 => "truck", 4 => "exclamation-triangle", _ => "question-circle" };
                                    }
                                    <span class="badge @badgeClass px-3 py-2 rounded-pill fs-6">
                                        <i class="bi bi-@iconClass me-1"></i>@status
                                    </span>
                                </td>
                                <td class="fw-medium text-warning ps-3 py-4">@order.EndTime.ToString("HH:mm") <i class="bi bi-alarm text-warning"></i></td>
                                <td class="ps-3 py-4">
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-sm btn-outline-info rounded-pill me-1" onclick="loadDelayHistory('@order.UId')" title="View Delay History">
                                            <i class="bi bi-eye me-1"></i>View History
                                        </button>
                                        <button class="btn btn-sm btn-outline-success rounded-pill" onclick="exportToExcel(this, '@order.UId')" title="Export Picking List to Excel">
                                            <i class="bi bi-file-earmark-excel me-1"></i>Export Excel
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <!-- Hidden Detail Row -->
                            <tr class="detail-row collapse" id="details_@order.UId">
                                <td colspan="9" class="p-0">
                                    <div class="bg-light p-4">
                                        <h6 class="fw-bold text-primary mb-3"><i class="bi bi-list-ul me-2"></i>Order Details for Customer @order.CustomerCode</h6>
                                        @if (order.OrderDetails != null && order.OrderDetails.Any())
                                        {
                                            <div class="table-wrapper">
                                                <table class="table table-sm table-hover mb-0 align-middle user-friendly-detail-table detail-order-table">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th class="border-0 fw-semibold text-dark ps-3 py-3"><i class="bi bi-chevron-down me-1"></i>Expand</th>
                                                            <th class="border-0 fw-semibold text-dark ps-3 py-3"><i class="bi bi-hash me-1"></i>Part No</th>
                                                            <th class="border-0 fw-semibold text-dark ps-3 py-3"><i class="bi bi-box me-1"></i>Cont No</th>
                                                            <th class="border-0 fw-semibold text-dark ps-3 py-3"><i class="bi bi-pallet me-1"></i>Pallet Size</th>
                                                            <th class="border-0 fw-semibold text-dark ps-3 py-3"><i class="bi bi-cart-plus me-1"></i>Quantity</th>
                                                            <th class="border-0 fw-semibold text-dark ps-3 py-3"><i class="bi bi-layers me-1"></i>Total Pallet</th>
                                                            <th class="border-0 fw-semibold text-dark ps-3 py-3"><i class="bi bi-building me-1"></i>Warehouse</th>
                                                            <th class="border-0 fw-semibold text-dark ps-3 py-3"><i class="bi bi-book me-1"></i>BookCont Status</th>
                                                            @* <th class="border-0 fw-semibold text-dark ps-3 py-3"><i class="bi bi-circle-fill me-1"></i>Status</th> *@
                                                        </tr>
                                                    </thead>
                                                    <tbody class="table-group-divider">
                                                        @foreach (var detail in order.OrderDetails.OrderBy(d => d.PartNo))
                                                        {
                                                            <tr class="align-middle animate-slide-in-up detail-row-tr" data-detail-id="@detail.UId">
                                                                <td class="ps-3 py-3 text-center">
                                                                    <button class="btn btn-sm btn-outline-secondary expand-detail-btn rounded-circle" data-bs-toggle="collapse" data-bs-target="#detailpallets_@detail.UId" aria-expanded="false" title="Expand Pallet Details">
                                                                        <i class="bi bi-caret-down"></i>
                                                                    </button>
                                                                </td>
                                                                <td class="fw-medium text-primary ps-3 py-3">@detail.PartNo</td>
                                                                <td class="text-muted ps-3 py-3">@detail.ContNo</td>
                                                                <td class="fw-semibold text-success ps-3 py-3">@detail.PalletSize <i class="bi bi-check-circle-fill text-success"></i></td>
                                                                <td class="fw-semibold text-info ps-3 py-3">@detail.Quantity <i class="bi bi-info-circle text-info"></i></td>
                                                                <td class="text-warning ps-3 py-3">@detail.TotalPallet</td>
                                                                <td class="text-secondary ps-3 py-3">@detail.Warehouse</td>
                                                                <td class="ps-3 py-3">
                                                                    @{
                                                                        var bookStatus = OrderDetailExtensions.GetBookContStatusText(detail.BookContStatus);
                                                                        var bookBadgeClass = OrderDetailExtensions.GetBadgeClass(detail.BookContStatus);
                                                                    }
                                                                    <span class="badge @bookBadgeClass px-2 py-1 rounded-pill fs-6">@bookStatus</span>
                                                                </td>
                                                                @* <td class="ps-3 py-3">
                                                                    @{
                                                                        var detailStatus = detail.Status switch { 0 => "Active", 1 => "Inactive", _ => detail.Status.ToString() };
                                                                        var statusBadgeClass = detail.Status switch { 0 => "bg-success text-white", 1 => "bg-danger text-white", _ => "bg-warning text-dark" };
                                                                    }
                                                                    <span class="badge @statusBadgeClass px-2 py-1 rounded-pill fs-6">@detailStatus</span>
                                                                </td> *@
                                                            </tr>
                                                            <!-- Hidden Pallet Detail Row -->
                                                            <tr class="pallet-detail-row collapse" id="detailpallets_@detail.UId">
                                                                <td colspan="9" class="p-0">
                                                                    <div class="bg-light p-3 ms-5">
                                                                        <h6 class="fw-bold text-primary mb-3"><i class="bi bi-pallet-stack me-2"></i>Pallet Details for Part @detail.PartNo</h6>
                                                                        @if (detail.ShoppingLists != null && detail.ShoppingLists.Any())
                                                                        {
                                                                            <div class="table-wrapper">
                                                                                <table class="table table-sm table-hover mb-0 align-middle user-friendly-pallet-table pallet-table">
                                                                                    <thead class="table-light">
                                                                                        <tr>
                                                                                            <th class="border-0 fw-semibold text-dark ps-3 py-3"><i class="bi bi-hash me-1"></i>Pallet No</th>
                                                                                            <th class="border-0 fw-semibold text-dark ps-3 py-3"><i class="bi bi-check-circle me-1"></i>PL Status</th>
                                                                                            <th class="border-0 fw-semibold text-dark ps-3 py-3"><i class="bi bi-calendar-check me-1"></i>Collected Date</th>
                                                                                            <th class="border-0 fw-semibold text-dark ps-3 py-3"><i class="bi bi-qr-code-scan"></i>Three Point Check Time</th>
                                                                                        </tr>
                                                                                    </thead> 
                                                                                    <tbody class="table-group-divider">
                                                                                        @foreach (var sl in detail.ShoppingLists.OrderBy(s => s.PalletNo))
                                                                                        {
                                                                                            <tr class="align-middle animate-slide-in-up">
                                                                                                <td class="fw-medium text-primary ps-3 py-3">@sl.PalletNo</td>
                                                                                                <td class="ps-3 py-3">
                                                                                                    @{
                                                                                                        var plStatus = sl.PLStatus switch
                                                                                                        {
                                                                                                            0 => "Chưa thu thập",
                                                                                                            1 => "Đã thu thập",
                                                                                                            2 => "Đã quét ba điểm",
                                                                                                            3 => "Đã Xuất",
                                                                                                            4 => "Đã Huỷ",
                                                                                                            _ => $"Unknown ({sl.PLStatus})"
                                                                                                        };
                                                                                                        var plBadgeClass = sl.PLStatus switch
                                                                                                        {
                                                                                                            0 => "bg-secondary text-white",
                                                                                                            1 => "bg-info text-white",
                                                                                                            2 => "bg-warning text-dark",
                                                                                                            3 => "bg-success text-white",
                                                                                                            4 => "bg-danger text-white",
                                                                                                            _ => "bg-light text-dark"
                                                                                                        };
                                                                                                    }
                                                                                                    <span class="badge @plBadgeClass px-2 py-1 rounded-pill fs-6">@plStatus</span>
                                                                                                </td>
                                                                                                <td class="fw-bolder text-dark">@(sl.CollectedDate?.ToString("dd-MM-yyyy HH:mm") ?? "N/A")</td>
                                                                                                <td class="fw-bolder text-dark">@(sl.ThreePointCheckTime?.ToString("dd-MM-yyyy HH:mm") ?? "N/A")</td>
                                                                                            </tr>
                                                                                        }
                                                                                    </tbody>
                                                                                </table>
                                                                            </div>
                                                                        }
                                                                        else
                                                                        {
                                                                            <p class="text-muted">No pallet details available.</p>
                                                                        }
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        }
                                                    </tbody>
                                                </table>
                                            </div>
                                        }
                                        else
                                        {
                                            <p class="text-muted">No order details available.</p>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
    <!-- Delay History Modal -->
    <div class="modal fade" id="delayModal" tabindex="-1" aria-labelledby="delayModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content border-0 shadow-xl rounded-4 animate-slide-in-down" style="border-radius: 20px;">
                <div class="modal-header bg-gradient-primary text-white border-0 rounded-top-4" style="background: linear-gradient(135deg, #0d6efd 0%, #6610f2 100%);">
                    <h5 class="modal-title fw-bold mb-0 d-flex align-items-center fs-3" id="delayModalLabel">
                        <i class="bi bi-clock-history me-2"></i>Delay History Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4 bg-light">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover align-middle user-friendly-delay-table" id="delayTable" style="border-radius: 12px; overflow: hidden;">
                            <thead class="table-light">
                                <tr>
                                    <th class="fw-semibold ps-3 py-4"><i class="bi bi-exclamation-triangle me-1 text-warning"></i>Delay Type</th>
                                    <th class="fw-semibold ps-3 py-4"><i class="bi bi-chat-text me-1 text-info"></i>Reason</th>
                                    <th class="fw-semibold ps-3 py-4"><i class="bi bi-clock me-1 text-primary"></i>Start Time</th>
                                    <th class="fw-semibold ps-3 py-4"><i class="bi bi-stopwatch me-1 text-danger"></i>Delay (Hours)</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer bg-gradient-light border-0 rounded-bottom-4 justify-content-center" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                    <button type="button" class="btn btn-secondary px-4 rounded-pill fs-5" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Close
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
@section Styles {
    <link href="~/css/OrderList.css" rel="stylesheet" />
}
@section Scripts {
    <script>
        window.appBaseUrl = window.appBaseUrl || '@Url.Content("~/")';
    </script>
    <script src="~/js/OrderList.js"></script>
}